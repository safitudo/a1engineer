# Generated by A1 Engineer — do not edit by hand.
# Team: <%- team.name %> (<%- team.id %>)

networks:
  net-<%- team.name %>:
    driver: bridge

volumes:
  git-<%- team.name %>:

<% const secretNames = Object.keys(secrets || {}) -%>
<% if (secretNames.length > 0) { -%>
secrets:
<% secretNames.forEach(function(name) { -%>
  <%- name %>:
    file: <%- secrets[name] %>
<% }); -%>

<% } -%>
services:

  # ── IRC server ─────────────────────────────────────────────────────────────
  ergo-<%- team.name %>:
    image: <%- ergo.image %>
    networks:
      - net-<%- team.name %>
<% if (ergo.hostPort) { -%>
    ports:
      - "<%- ergo.hostPort %>:<%- ergo.port || 6667 %>"
<% } -%>
    volumes:
      - type: bind
        source: <%- ergo.configPath %>
        target: /ircd/ircd.yaml
        read_only: true
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "<%- ergo.port || 6667 %>"]
      interval: 2s
      timeout: 2s
      retries: 10
      start_period: 3s
    restart: unless-stopped

  # ── Git volume initialiser (one-shot) ──────────────────────────────────────
  git-init-<%- team.name %>:
    image: a1-git-init:latest
    volumes:
      - git-<%- team.name %>:/git
    environment:
      REPO_URL: <%- JSON.stringify(repo.url) %>
      REPO_BRANCH: <%- JSON.stringify(repo.branch) %>
      AGENTS: <%- JSON.stringify(JSON.stringify(agents.map(function(a){ return { id: a.id, role: a.role, city: team.name }; }))) %>
<% if (repo.githubToken) { -%>
      GITHUB_TOKEN: <%- JSON.stringify(repo.githubToken) %>
<% } -%>
    restart: "no"

<% agents.forEach(function(agent) { -%>
<%   var isSession = agent._authMode === 'session'; -%>
<%   // Per-agent secrets: github_token always; anthropic_key for api-key, anthropic_session for session -%>
<%   var agentSecrets = secretNames.filter(function(n) {
       if (n === 'anthropic_key') return !isSession;
       if (n === 'anthropic_session') return isSession;
       return true;
     }); -%>
  # ── Agent: <%- agent.id %> (<%- agent.role %>) [<%- agent._authMode %>] ────
  agent-<%- agent.id %>:
    image: a1-agent-<%- agent.runtime %>:latest
    networks:
      - net-<%- team.name %>
    volumes:
      - git-<%- team.name %>:/git
<% if (isSession && sessionResolvedPath) { -%>
      - type: bind
        source: <%- sessionResolvedPath %>
        target: /root/.claude-host
        read_only: true
<% } -%>
    working_dir: "/git/worktrees/<%- agent.id %>"
    environment:
      IRC_HOST: "ergo-<%- team.name %>"
      IRC_PORT: "<%- ergo.port || 6667 %>"
      IRC_NICK: "<%- agent.id %>"
      IRC_ROLE: "<%- agent.role %>"
      CITY: "<%- team.name %>"
      AGENT_RUNTIME: "<%- agent.runtime %>"
      MODEL: "<%- agent.model %>"
      CLAUDE_CODE_EFFORT_LEVEL: "<%- agent.effort || 'high' %>"
      TEAM_ID: "<%- team.id %>"
      MANAGER_URL: "http://host.docker.internal:8080"
      HEARTBEAT_URL: "http://host.docker.internal:8080/heartbeat/<%- team.id %>/<%- agent.id %>"
      MANAGER_TOKEN: "<%- team.internalToken %>"
      WORKSPACE: "/git"
      AGENT_PROMPT: <%- JSON.stringify(agent.prompt) %>
      WORKTREE_PATH: "/git/worktrees/<%- agent.id %>"
<% Object.entries(agent.env || {}).forEach(function([k, v]) { -%>
      <%- k %>: <%- JSON.stringify(String(v)) %>
<% }); -%>
<% if (agentSecrets.length > 0) { -%>
    secrets:
<% agentSecrets.forEach(function(name) { -%>
      - <%- name %>
<% }); -%>
<% } -%>
    depends_on:
      ergo-<%- team.name %>:
        condition: service_healthy
      git-init-<%- team.name %>:
        condition: service_completed_successfully
    restart: unless-stopped

<% }); -%>

# Generated by A1 Engineer — do not edit by hand.
# Team: <%- team.name %> (<%- team.id %>)

version: "3.9"

networks:
  net-<%- team.name %>:
    driver: bridge

volumes:
  git-<%- team.name %>:

services:

  # ── IRC server ─────────────────────────────────────────────────────────────
  ergo-<%- team.name %>:
    image: <%- ergo.image %>
    networks:
      - net-<%- team.name %>
    volumes:
      - type: bind
        source: <%- ergo.configPath %>
        target: /ircd/config/ircd.yaml
        read_only: true
    restart: unless-stopped

  # ── Git volume initialiser (one-shot) ──────────────────────────────────────
  git-init-<%- team.name %>:
    image: alpine/git
    volumes:
      - git-<%- team.name %>:/git
    environment:
      REPO_URL: <%- JSON.stringify(repo.url) %>
      REPO_BRANCH: <%- JSON.stringify(repo.branch) %>
    entrypoint: ["/bin/sh", "-c"]
    command: "[ -d /git/.git ] || git clone --branch $$REPO_BRANCH $$REPO_URL /git"
    restart: "no"

<% agents.forEach(function(agent) { -%>
  # ── Agent: <%- agent.id %> (<%- agent.role %>) ─────────────────────────────
  agent-<%- agent.id %>:
    image: a1-agent-<%- agent.runtime %>:latest
    networks:
      - net-<%- team.name %>
    volumes:
      - git-<%- team.name %>:/git
    environment:
      IRC_HOST: "ergo-<%- team.name %>"
      IRC_PORT: "<%- ergo.port || 6667 %>"
      IRC_NICK: "<%- agent.id %>"
      IRC_ROLE: "<%- agent.role %>"
      CITY: "<%- team.name %>"
      AGENT_RUNTIME: "<%- agent.runtime %>"
      MODEL: "<%- agent.model %>"
      HEARTBEAT_URL: "http://manager:8080/heartbeat/<%- team.id %>/<%- agent.id %>"
      WORKSPACE: "/git"
      AGENT_PROMPT: <%- JSON.stringify(agent.prompt) %>
<% Object.entries(agent.env || {}).forEach(function([k, v]) { -%>
      <%- k %>: <%- JSON.stringify(String(v)) %>
<% }); -%>
    depends_on:
      ergo-<%- team.name %>:
        condition: service_started
      git-init-<%- team.name %>:
        condition: service_completed_successfully
    restart: unless-stopped

<% }); -%>

#!/usr/bin/env bash
# Git credential helper that fetches fresh GitHub tokens from Manager API.
# Replaces static .netrc â€” tokens auto-refresh, never expire during a session.
#
# Usage: git config --global credential.helper '/usr/local/bin/git-credential-manager-token'

set -e

# Only respond to "get" requests
[ "$1" = "get" ] || exit 0

# Read stdin (git sends host=, protocol=, etc.)
while IFS='=' read -r key value; do
  case "$key" in
    host) HOST="$value" ;;
  esac
done

# Only handle github.com
[ "$HOST" = "github.com" ] || exit 0

# Fetch fresh token from Manager API
MANAGER="${MANAGER_URL:-http://host.docker.internal:8080}"
TEAM="${TEAM_ID:-}"

if [ -z "$TEAM" ]; then
  # Fallback to static token if no team context
  [ -n "${GITHUB_TOKEN:-}" ] && printf 'protocol=https\nhost=github.com\nusername=x-access-token\npassword=%s\n' "$GITHUB_TOKEN"
  exit 0
fi

TOKEN=$(curl -sf "${MANAGER}/github-token/${TEAM}" 2>/dev/null | jq -r '.token // empty' 2>/dev/null)

if [ -n "$TOKEN" ]; then
  printf 'protocol=https\nhost=github.com\nusername=x-access-token\npassword=%s\n' "$TOKEN"
else
  # Fallback to static token from env
  [ -n "${GITHUB_TOKEN:-}" ] && printf 'protocol=https\nhost=github.com\nusername=x-access-token\npassword=%s\n' "$GITHUB_TOKEN"
fi
